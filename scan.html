<script>
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/<script>
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyO44stGrJBgg1cT8VXC0h8UkP1espWojgg2yOcbki4M8I1CPfWnoFiqUp2tEDtQdqs/exec";

  function post(payload){
    return fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }

  async function onScanSuccess(decodedText, decodedResult) {
    // --- DEBUG: show exactly what the camera scanned ---
    alert("SCANNED: " + decodedText);

    // stop scanner while we process
    await html5QrcodeScanner.clear();

    console.log('decodedText:', decodedText);

    // first call: check product info
    try {
      const scanResp = await post({ action: 'scan', barcode: decodedText });
      console.log('scan response:', scanResp);

      if (scanResp.error) {
        // show the error returned by the API
        alert('Server response: ' + scanResp.error);
        html5QrcodeScanner.render(onScanSuccess);
        return;
      }

      const p = scanResp.product;
      if (!p) {
        alert('No product data returned.');
        html5QrcodeScanner.render(onScanSuccess);
        return;
      }

      const confirmSell = confirm(`Sell 1 x ${p.name}?\nStock left: ${p.quantity}`);
      if (!confirmSell) {
        html5QrcodeScanner.render(onScanSuccess);
        return;
      }

      // second call: perform sell
      const sellResp = await post({ action: 'sell', barcode: decodedText, qty: 1, user: 'cashier' });
      console.log('sell response:', sellResp);

      if (sellResp.success) {
        alert('Sold! Remaining: ' + sellResp.newQuantity);
      } else if (sellResp.error) {
        alert('Sell failed: ' + sellResp.error);
      } else {
        alert('Unexpected response: ' + JSON.stringify(sellResp));
      }
    } catch (err) {
      console.error('Network or JS error:', err);
      alert('Network error: ' + err);
    } finally {
      html5QrcodeScanner.render(onScanSuccess);
    }
  }

  const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 200 });
  html5QrcodeScanner.render(onScanSuccess);
</script>
/exec";

  function post(payload){
    return fetch(APPS_SCRIPT_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }

  async function onScanSuccess(decodedText, decodedResult) {
    // --- DEBUG: show exactly what the camera scanned ---
    alert("SCANNED: " + decodedText);

    // stop scanner while we process
    await html5QrcodeScanner.clear();

    console.log('decodedText:', decodedText);

    // first call: check product info
    try {
      const scanResp = await post({ action: 'scan', barcode: decodedText });
      console.log('scan response:', scanResp);

      if (scanResp.error) {
        // show the error returned by the API
        alert('Server response: ' + scanResp.error);
        html5QrcodeScanner.render(onScanSuccess);
        return;
      }

      const p = scanResp.product;
      if (!p) {
        alert('No product data returned.');
        html5QrcodeScanner.render(onScanSuccess);
        return;
      }

      const confirmSell = confirm(`Sell 1 x ${p.name}?\nStock left: ${p.quantity}`);
      if (!confirmSell) {
        html5QrcodeScanner.render(onScanSuccess);
        return;
      }

      // second call: perform sell
      const sellResp = await post({ action: 'sell', barcode: decodedText, qty: 1, user: 'cashier' });
      console.log('sell response:', sellResp);

      if (sellResp.success) {
        alert('Sold! Remaining: ' + sellResp.newQuantity);
      } else if (sellResp.error) {
        alert('Sell failed: ' + sellResp.error);
      } else {
        alert('Unexpected response: ' + JSON.stringify(sellResp));
      }
    } catch (err) {
      console.error('Network or JS error:', err);
      alert('Network error: ' + err);
    } finally {
      html5QrcodeScanner.render(onScanSuccess);
    }
  }

  const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 200 });
  html5QrcodeScanner.render(onScanSuccess);
</script>
